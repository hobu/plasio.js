<html>
  <style>
    body {
        margin: 0px;
    }
    #stats {
        font-family: 'Consolas', 'Monaco', monospace;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2px;
        position: absolute;
        top: 5px;
        right: 5px;
    }
  </style>

<body>
    <div id="app" style="width:100%;height:600px;"></div>
    <div id="stats"></div>

    <script src="renderer/plasio-renderer.js"></script>
    <script src="lib/dist/plasio-lib.js"></script>

    <script>
     var commonStartup = function() {
       var stats = {}
       var renderStats = function(ps, ds) {
         stats.ps = ps || stats.ps;
         stats.ds = ds || stats.ds;

         if (stats.ps && stats.ds) {
           document.getElementById("stats").innerHTML =
           "Pool: active: " + stats.ps.inuse +
           ", waiting: " + stats.ps.waiting +
           ", max:" + stats.ps.max + "| Totals: points: " +
           stats.ds.totalPoints + ", bytes: " + stats.ds.totalBytes;
         }
       };

       var e = document.getElementById("app");

       var baseSource = PlasioLib.GreyhoundStatic;
       var r = renderer.core.createRenderer(e);
       /*
       var p = new baseSource.NodeDistancePolicy(r,
       "localhost:8080", "4da95360946af6a58f36ef92fa65e4cc");
        */
       var baseURL = "http://localhost:4999";
       var p = new baseSource.NodeDistancePolicy(r, baseURL);
       var loader = new baseSource.Loader(baseURL);
       r.addLoader(loader);
       loader.on("pool-stats", function(stats) {
         renderStats(stats);
       });

       loader.on("download-stats", function(stats) {
         renderStats(null, stats);
       });

       var handleResize = function () {
         r.setRenderViewSize(window.innerWidth, window.innerHeight);
       };

       window.onresize = handleResize;
       handleResize();

       PlasioLib.P2PNode.key = "d498vphryc8lg14i";
       return { element: e, renderer: r, policy: p };
     };

     var ownerStartup = function() {
       var s = commonStartup();

       var peer = new PlasioLib.P2PNode("owner");
       peer.startBroadcast();

       var e = s.element;
       var r = s.renderer;
       var p = s.policy;

       r.addPropertyListener([], function(state) {
         console.log("state is:", state);
         peer.broadcastState(state);
       });
       
       var c = new PlasioLib.Cameras.Orbital(e, r, function(eye, target) {
         r.setEyePosition(eye);
         r.setTargetPosition(target);
       });

       r.setClearColor(0, 0, 0);

       p.on("bbox", function(bbox) {
         var x = bbox.maxs[0] - bbox.mins[0],
         y = bbox.maxs[1] - bbox.mins[1],
         z = bbox.maxs[2] - bbox.mins[2];
         
         var off = [
           bbox.mins[0] + x / 2,
           bbox.mins[1] + y / 2,
           bbox.mins[2] + z / 2
         ];

         console.log("Setting offsets to:", off);
         r.setRenderOptions({
           offsets: off
         });

         // reset the state of our camera
         c.setHint([x, y, z]);
       });

       p.start();

     };

     var viewerStartup = function(name) {
       var s = commonStartup();

       var peer = new PlasioLib.P2PNode(name);
       var e = peer.startAsClient("owner");

       e.on("state", function(state) {
         console.log("state is:", state);
         s.renderer.applyState(state);
       });
     };

     ownerStartup();
        
    </script>

</body>
</html>
