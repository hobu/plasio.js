<html>
  <style>
    body {
        margin: 0px;
    }
    #stats {
        font-family: 'Consolas', 'Monaco', monospace;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2px;
        position: absolute;
        top: 5px;
        right: 5px;
    }
  </style>

<body>
    <div id="app" style="width:100%;height:600px;"></div>
    <div id="stats"></div>

    <script src="renderer/plasio-renderer.js"></script>
    <script src="lib/dist/plasio-lib.js"></script>

    <script>
     var commonStartup = function() {
       var stats = {}
       var renderStats = function(ps, ds) {
         stats.ps = ps || stats.ps;
         stats.ds = ds || stats.ds;

         if (stats.ps && stats.ds) {
           document.getElementById("stats").innerHTML =
           "Pool: active: " + stats.ps.inuse +
           ", waiting: " + stats.ps.waiting +
           ", max:" + stats.ps.max + "| Totals: points: " +
           stats.ds.totalPoints + ", bytes: " + stats.ds.totalBytes;
         }
       };

       var e = document.getElementById("app");

       var r = renderer.core.createRenderer(e);
       /*
       var p = new baseSource.NodeDistancePolicy(r,
       "localhost:8080", "4da95360946af6a58f36ef92fa65e4cc");
        */
       var baseURL = "http://52.0.151.178";
       var pipelineId = "c924dbf6d0b1f761618d09e8feb4aa31";
       
       var bbox = [-10796577.371225, 4902908.135781, -10015953.953824, 5375808.896799];


       var loaders = {
         point: new PlasioLib.Loaders.GreyhoundPipelineLoader(baseURL, pipelineId),
         overlay: new PlasioLib.Loaders.MapboxLoader(),
         transform: new PlasioLib.Loaders.TransformLoader()
       };
         
       var p = new PlasioLib.NodeDistancePolicy(loaders, r, bbox);
       for (var l in loaders) {
         r.addLoader(loaders[l].constructor);
       }

       var handleResize = function () {
         r.setRenderViewSize(window.innerWidth, window.innerHeight);
       };

       window.onresize = handleResize;
       handleResize();

       PlasioLib.P2PNode.key = "d498vphryc8lg14i";
       return { element: e, renderer: r, policy: p };
     };

     var ownerStartup = function() {
       var s = commonStartup();

       var e = s.element;
       var r = s.renderer;
       var p = s.policy;

       r.addPropertyListener([], function(state) {
         //console.log("state is:", state);
       });
       
       var c = new PlasioLib.Cameras.Orbital(e, r, function(eye, target) {
         r.setEyePosition(eye);
         r.setTargetPosition(target);
       });

       r.setClearColor(0, 0, 0);

       p.on("bbox", function(bbox) {
         var x = bbox.maxs[0] - bbox.mins[0],
         y = bbox.maxs[1] - bbox.mins[1],
         z = bbox.maxs[2] - bbox.mins[2];
         
         // reset the state of our camera
         c.setHint([x, y, z]);

         // update our renderer to set far clip plane to pretty far
         var farPlane = Math.sqrt(x*x + y*y) * 2;
         r.updateCamera(0, {far: farPlane});
         
       });

       p.start();

     };

     ownerStartup();
        
    </script>

</body>
</html>
