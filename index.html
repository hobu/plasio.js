<html>
  <style>
    body {
        margin: 0px;
    }
    #stats {
        font-family: 'Consolas', 'Monaco', monospace;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2px;
        position: absolute;
        top: 5px;
        right: 5px;
    }
  </style>

<body>
    <div id="app" style="width:100%;height:600px;"></div>
    <div id="stats"></div>
    <script>
       var DECOMPRESS_WORKER_PATH="/workers/decompress.js"
    </script>

    <script src="renderer/plasio-renderer.js"></script>
    <script src="lib/dist/plasio-lib.js"></script>

    <script>
     var dp = null; // do profile, function that does profile stuff for us
     var clearLines = null; // clear lines
     var lines = [];

     var commonStartup = function() {
       var stats = {}
       var renderStats = function(ps, ds) {
         stats.ps = ps || stats.ps;
         stats.ds = ds || stats.ds;

         if (stats.ps && stats.ds) {
           document.getElementById("stats").innerHTML =
           "Pool: active: " + stats.ps.inuse +
           ", waiting: " + stats.ps.waiting +
           ", max:" + stats.ps.max + "| Totals: points: " +
           stats.ds.totalPoints + ", bytes: " + stats.ds.totalBytes;
         }
       };

       var e = document.getElementById("app");

       var r = renderer.core.createRenderer(e);
       /*
       var p = new baseSource.NodeDistancePolicy(r,
       "localhost:8080", "4da95360946af6a58f36ef92fa65e4cc");
        */

       var baseURL = "http://52.4.221.249:8080";
       var pipelineId = "mini-shred";

       var baseURL = "http://data.iowalidar.com";
       var pipelineId = "ia-nineteen";

       var baseURL = "http://data-link.iowalidar.com";
       var pipelineId = "iowa-dyn";

       var baseURL = "http://52.0.223.227";
       var pipelineId = "nepal";

       //var baseURL = "http://54.157.130.127";
         /*
       var baseURL = "http://dh1bhcvxlzpg1.cloudfront.net";
       var pipelineId = "iowa-link";
            */

       
       // var bbox = [-10796577.371225, 4902908.135781, -10015953.953824, 5375808.896799];
       //var bbox = [-10755071.77716193,4894622.884751885, -9979898.42756837,5405017.135473464];
       // var bbox = [-10214432.963804673, 5087648.60266133, -10175297.205322662, 5126784.361143343];

         /*
         var bbox = [
             // Whole state in web-mercator.
             -10796577.371225, 4902908.135781, 0,
             -10015953.953824, 5375808.896799, 1000
         ]
            */
         var bbox = [
             348327,
             3067668,
             1329.97,
             349361,
             3068647,
             1399.52
         ]

       var MAX_DEPTH = 14;


       var loaders = {
         point: new PlasioLib.Loaders.GreyhoundPipelineLoader(baseURL, pipelineId, MAX_DEPTH, true, true, true),
         overlay: new PlasioLib.Loaders.MapboxLoader(),
         transform: new PlasioLib.Loaders.TransformLoader()
       };
         
       var p = new PlasioLib.FrustumLODNodePolicy(loaders, r, bbox, 20, MAX_DEPTH);
       for (var l in loaders) {
         r.addLoader(loaders[l].constructor);
       }

       var handleResize = function () {
         r.setRenderViewSize(window.innerWidth, window.innerHeight);
       };

       window.onresize = handleResize;
       handleResize();

       console.log(history);


        dp = function() {
            // test function to trigger profiler
            console.log("dp:", lines);
            if (lines.length === 0)
                return;

            var p = new PlasioLib.Features.Profiler(r);
            p.profileLines(lines, bbox);
        };

       r.addPropertyListener(["line-segments"], function(l) {
           if (!l) return;

           lines = l.map(function(_l) {
               return [_l[1], _l[2], _l[3]];
           });
       });



       PlasioLib.P2PNode.key = "d498vphryc8lg14i";
       return { element: e, renderer: r, policy: p };
     };

     var decomposeCamParameters = function() {
         var q = window.location.search;
         if (q.length === 0) return null;

         q = q.slice(1);
         var s = q.split("&").reduce(function(a, v) {
             var p = v.split("=");
             var k = p[0], v = JSON.parse(decodeURIComponent(p[1]));
             a[k] = v;
             return a;
         }, {});


         return s;
     };

     var ownerStartup = function() {
       var s = commonStartup();

       var e = s.element;
       var r = s.renderer;
       var p = s.policy;


       // for playing in repl
       window.s = s;

         
       var camParams = decomposeCamParameters();

       console.log("Camera parameters:", camParams);

       var c = new PlasioLib.Cameras.Orbital(e, r, function(eye, target) {
         r.setEyePosition(eye);
         r.setTargetPosition(target);
       }, camParams);

       // do some history setup
       window.onpopstate = function(event) {
           console.log("STATE!!!!");
           c.applyState(event.state);
       };

       r.setClearColor(0.1, 0, 0);
       r.setRenderOptions({
         pointSize: 2,
         rgb_f: 0.0,
         overlay_f: 1.0,
         maxColorComponent: (1 << 16)
       });

       p.on("bbox", function(bbox) {
         var x = bbox.maxs[0] - bbox.mins[0],
         y = bbox.maxs[1] - bbox.mins[1],
         z = bbox.maxs[2] - bbox.mins[2];
         
         // reset the state of our camera
         if (!camParams)
               c.setHint([x, y, z]);

         // update our renderer to set far clip plane to pretty far
         var farPlane = Math.sqrt(x*x + y*y) * 2;
         r.updateCamera(0, {far: farPlane});
         
       });

       p.on("view-changed", function() {
           var state = c.serialize();

           var kv = function(k, first) {
               return (first ? "?" : "&") + encodeURIComponent(k) + "=" + encodeURIComponent(JSON.stringify(state[k]));
           };

           var s = kv('distance', true) + kv('elevation') + kv('azimuth') + kv('maxDistance') + kv('distance') + kv('target');

           history.pushState(state, "Viewing stuffs", s);
       });


       var mode = new PlasioLib.Modes.LinePicker(e, r);

        clearLines = function() {
            console.log("clearing lines!");
            mode.resetState();
        };


       document.addEventListener("keydown", function(evt) {
           console.log("keydown");
           if (evt.keyCode === 16) {
               c.enableControls(false);
               mode.activate();
           }
       });

       document.addEventListener("keyup", function(evt) {
           if (evt.keyCode === 16) {
               c.enableControls(true);
               mode.deactivate();
           }
       });

       p.start();
     };

     ownerStartup();
    </script>

    <button style="position:absolute;top:10px;right:10px;z-index:10000"
            onclick="javascript:dp()">Do Profile</button>

    <button style="position:absolute;top:10px;right:80px;z-index:10000"
            onclick="javascript:clearLines()">Clear Lines</button>

</body>
</html>
