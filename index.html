<html>
  <style>
    body {
        margin: 0px;
    }
    #stats {
        font-family: 'Consolas', 'Monaco', monospace;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2px;
        position: absolute;
        top: 5px;
        right: 5px;
    }
  </style>

<body>
    <div id="app" style="width:100%;height:600px;"></div>
    <div id="stats"></div>
    <script>
       var DECOMPRESS_WORKER_PATH="/workers/decompress.js"
    </script>

    <srcipt src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.3.1/gl-matrix-min.js"></srcipt>
    <script src="renderer/target/dev/renderer.js"></script>

    <script src="lib/dist/plasio-lib.js"></script>

    <script>
        var SERVER = "http://devdata.greyhound.io";
        var RESOURCE = "nyc";
        var IMAGERY_SOURCE_0 = "local://elevation";
        var IMAGERY_SOURCE_1 = "local://intensity";
        var IMAGERY_SOURCE_2 = "http://api.tiles.mapbox.com/v4/mapbox.comic/{{z}}/{{x}}/{{y}}.jpg70?access_token=pk.eyJ1IjoiaG9idSIsImEiOiItRUhHLW9NIn0.RJvshvzdstRBtmuzSzmLZw"
        var IMAGERY_SOURCE_3 = "http://api.tiles.mapbox.com/v4/mapbox.satellite/{{z}}/{{x}}/{{y}}.jpg70?access_token=pk.eyJ1IjoiaG9idSIsImEiOiItRUhHLW9NIn0.RJvshvzdstRBtmuzSzmLZw"

        // WARN: Not a good idea!
        PlasioLib.FrustumLODNodePolicy.REJECT_ON_SCREEN_SIZE_RADIUS = 300;

        var lines = [];


        var get = function(url, cb) {
            var r = new XMLHttpRequest();
            r.onload = function() {
                if (r.status === 200) {
                    return cb(JSON.parse(r.response));
                }

                throw new Error("HTTP/GET failed for: " + url);
            };

            r.open("get", url);
            r.send();
        };

        var enablePointPicker = null, disablePointPicker = null;
        var doLOS = null;


        var totalBBox = null;

        var commonStartup = function(f) {
            var stats = {};

            var e = document.getElementById("app");
            var r = renderer.core.createRenderer(e);

            get(SERVER + "/resource/" + RESOURCE + "/info", function(obj) {
                var bbox = obj.bounds.slice(0);
                var schema = obj.schema;

                // determine and set splitting cutoffs
                var stopSplitLevel = Math.ceil(Math.log(obj.numPoints) / Math.log(4)) + 1;

                PlasioLib.FrustumLODNodePolicy.STOP_SPLIT_DEPTH = stopSplitLevel;
                PlasioLib.FrustumLODNodePolicy.HARD_STOP_DEPTH = stopSplitLevel * 2;

                // put bbox in correct space, y goes up.
                bbox = [bbox[0], bbox[2], bbox[1], bbox[3], bbox[5], bbox[4]];


                totalBBox = bbox;

                var loaders = [
                    new PlasioLib.Loaders.GreyhoundPipelineLoader(SERVER, RESOURCE, schema, {
                        imagerySources: [IMAGERY_SOURCE_0, IMAGERY_SOURCE_1, IMAGERY_SOURCE_2, IMAGERY_SOURCE_3]
                    }),
                    new PlasioLib.Loaders.TransformLoader()
                ];

                var p = new PlasioLib.FrustumLODNodePolicy(loaders, r, {
                    pointCloudBBox: bbox,
                    normalize: true
                });

                loaders.forEach(function(l) {
                    r.addLoader(l.constructor);
                });

                var handleResize = function () {
                    r.setRenderViewSize(window.innerWidth, window.innerHeight);
                };

                window.onresize = handleResize;
                handleResize();

                /*
                overlay = function () {
                    var c = document.createElement("canvas");
                    c.width = 512;
                    c.height = 512;
                    var ctx = c.getContext('2d');

                    ctx.strokeStyle = "#ff0000";

                    ctx.lineWidth = 5;
                    ctx.strokeRect(50, 50, 200, 200);

                    r.addOverlay("1234", [-40000, -20000, 40000, 20000], c);
                };

                roverlay = function () {
                    r.removeOverlay("1234");
                };
                 */

                f({element: e, renderer: r, policy: p, bbox: bbox, loaders: loaders});
            });
        };

        var decomposeCamParameters = function() {
            var q = window.location.search;
            if (q.length === 0) return null;

            q = q.slice(1);
            var s = q.split("&").reduce(function(a, v) {
                var p = v.split("=");
                var k = p[0], v = JSON.parse(decodeURIComponent(p[1]));
                a[k] = v;
                return a;
            }, {});


            return s;
        };

        var renderProfile = function(out) {
            console.log(out);

            var canvas = document.createElement("canvas");
            canvas.width = 1000;
            canvas.height = 200;
            var ctx = canvas.getContext("2d");

            var mapr = function(ins, ine, inval, outs, oute) {
                return outs + (oute - outs) * (inval - ins) / (ine - ins);
            };

            var ry = (out.maxs[1] - out.mins[1]) / (out.maxs[0] - out.mins[1]);

            var f = function(x, y, z) {
                // given a point, figure out where in the canvas it goes
                return [mapr(out.mins[0], out.maxs[0], x, 30, canvas.width - 30),
                    canvas.height - mapr(out.mins[1], out.maxs[1], y, 50, canvas.height - 50)];
            };


            var buffer = out.buffer;
            var numPoints = buffer.length / 7;
            ctx.fillStyle = "#010";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            var off = 0;
            ctx.fillStyle = "red";
            var renderCount = 0;
            for (var i = 0 ; i < numPoints ; i ++) {
                var x = buffer[off], y = buffer[off + 1], z = buffer[off + 2];
                var r = buffer[off+3], g = buffer[off+4], b = buffer[off+5];

                var col = "rgb(" + r + "," + g + "," + b +")";
                var pos = f(x, y, z);

                ctx.fillStyle = col;
                ctx.fillRect(pos[0], pos[1], 2, 2);

                off += 7;

                renderCount ++;
            }

            console.log("total points rendererd:", renderCount);

            canvas.style.position = "absolute";
            canvas.style.bottom = "5px";
            canvas.style.left = "5px";

            document.body.appendChild(canvas);
        };


        var ownerStartup = function() {
            var s = commonStartup(function(s) {

                var e = s.element;
                var r = s.renderer;
                var p = s.policy;


                // for playing in repl
                window.s = s;

                var camParams = decomposeCamParameters();

                console.log("Camera parameters:", camParams);

                var appConfig = {
                    pointCloudBounds: s.bbox
                };

                var modeManager = new PlasioLib.ModeManager(e, r,
                        appConfig,
                        function(eye, target) {
                            r.setEyeTargetPosition(eye, target);
                        }, camParams);

                modeManager.addActionListener(function(actions) {
                    console.log("context menu actions:", actions);
                    if (actions["profile"]) {
                        var fn = actions["profile"][1];
                        if(fn) {
                            console.log("Have profile action! calling...");
                            fn.call(null, function(err, res) {
                                renderProfile(res[0]);
                            });
                        }
                    }
                });

                s.camera = null;
                s.modeManager = modeManager;

                // do some history setup
                window.onpopstate = function (event) {
                    modeManager.activeCamera.deserialize(event.state);
                };

                r.setClearColor(0.4, 0, 0);
                r.setRenderOptions({pointSize: 2, colorBlendWeights: [1.0, 1.0, 1, 1]});

                p.on("bbox", function (bbox) {
                    console.log("-- -- bounding box:", bbox);
                    var x = bbox.maxs[0] - bbox.mins[0],
                            y = bbox.maxs[1] - bbox.mins[1],
                            z = bbox.maxs[2] - bbox.mins[2];

                    // reset the state of our camera
                    if (!camParams)
                        modeManager.propagateDataRangeHint(x, y, z);

                    // update our renderer to set far clip plane to pretty far
                    var farPlane = Math.sqrt(x * x + y * y) * 2;
                    r.updateCamera(0, {far: farPlane});

                    s.bboxActual = bbox;

                });

                p.on("view-changed", function () {
                    var state = modeManager.activeCamera.serialize();

                    console.log('++ ', state);

                    var kv = function (k, first) {
                        return (first ? "?" : "&") + encodeURIComponent(k) + "=" + encodeURIComponent(JSON.stringify(state[k]));
                    };

                    var s = kv('distance', true) + kv('elevation') + kv('azimuth') + kv('maxDistance') + kv('distance') + kv('target');

                    history.pushState(state, "Viewing stuffs", s);
                });

                p.start();

                enablePointPicker = function() {
                    modeManager.activeMode = "line";
                };

                disablePointPicker = function() {
                    modeManager.activeMode = "camera";
                };

                doLOS = function() {
                    /*
                    console.log("Loading secondary view...");
                    var sec = document.createElement("div");

                    sec.style.width = "640px";
                    sec.style.height = "480px";
                    sec.style.position = "absolute";
                    sec.style.right = "10px";
                    sec.style.top = "60px";

                    var profileRenderer = renderer.core.createRenderer(sec);

                    document.body.appendChild(sec);

                    console.log("Secondary renderer created!");

                    profileRenderer.setClearColor(1.0, 1.0, 0.0);
                    profileRenderer.setRenderViewSize(640, 480);
                    profileRenderer.setRenderOptions({
                        pointSize: 2,
                    });

                    console.log("Secondary renderer created!");
                    window.profileRenderer = profileRenderer;


                    // Load the profile loader policy
                    //
                    var policy = new PlasioLib.ProfileLoaderPolicy(r, profileRenderer, {
                        fullPointCloudBBox: window.s.bboxActual
                    });

                    policy.setProfileRegions({
                        start: [-1000, 0, 0],
                        end: [1000, 0, 0],
                        width: 100
                    });
                    */


                    //r.addHighlightSegment("what", [-5000, 0, 0], [5000, 0, 0], 100);
                    //r.addHighlightSegment("why", [1000, 0, 1000], [-1000, 0, -1000], 100);
                    /*
                    var profiler = new PlasioLib.Features.Profiler(r, [[[-1000, 0, 0], [1000, 0, 0]]], 50);
                    console.time("timer");
                    profiler.extractProfile(false, function(err, res) {
                        console.timeEnd("timer");
                        // we only sent down a single segment, so get results for the first one
                        //
                        var out = res[0];
                        renderProfile(out);
                    });
                    */
                    /*
                    var identity = mat4.identity(mat4.create());
                    var view = identity;

                    console.log(totalBBox);

                    var range = [totalBBox[3] - totalBBox[0], totalBBox[5] - totalBBox[2]];


                    //mat4.rotateZ(view, view, 3.14159265);
                    mat4.rotateX(view, view, Math.PI / 2);


                    console.log(range);
                    var proj = mat4.ortho(mat4.create(), +range[0]/2, -range[0]/2,
                            -range[1]/2, range[1]/2, -1000000, 1000000);

                    var mat = mat4.multiply(mat4.create(), proj, view);

                    var SIZE = 256;
                    var res = r.projectToImage(mat, 1, SIZE);

                    console.log(res);

                    var c = document.createElement("canvas");
                    c.width = SIZE;
                    c.height = SIZE;
                    c.style.position = "absolute";
                    c.style.left = c.style.top = 0;
                    c.style.width = 256;
                    c.style.height = 256;

                    var ctx = c.getContext("2d");

                    var m = -999999999999, n = 99999999999;
                    for(var i = 0 ; i < res.length ; i++) {
                        m = Math.max(m, res[i]);
                        n = Math.min(n, res[i]);
                    }

                    console.log("m,n", m, n);

                    for (var off = 0 ; off < res.length ; off ++) {
                        var v = res[off];
                        var clf = (v - n) / (m - n);

                        clf = clf * 255;
                        var col = "rgb(" + Math.floor(clf) + ",0,0)";

                        if (off < 100) {
                            console.log(col);
                        }

                        ctx.fillStyle = col;

                        var x = off % SIZE;
                        var y = Math.floor(off / SIZE);

                        ctx.fillRect(x, y, 1, 1);
                    }

                    document.body.appendChild(c);
                    */

                    /*
                    var image = new Image();
                    image.crossOrigin = "";
                    image.onload = function() {
                        console.log("Image loaded, adding overlay!");
                        var bounds = [-10000, -10000, 10000, 10000];

                        r.addOverlay("los-12314", bounds, image);
                        console.log("Overlay addede!");

                    };
                    image.src = "https://placekitten.com/1024/1024";
                    console.log("Doing line of sight!");
                    */
                }
            });
        };

        ownerStartup();
    </script>

    <button style="position:absolute;top:10px;right:280px;z-index:10000"
            onclick="javascript:enablePointPicker();">Enable Point Picker</button>

    <button style="position:absolute;top:10px;right:150px;z-index:10000"
            onclick="javascript:disablePointPicker();">Disable Point Picker</button>

    <button style="position:absolute;top:50px;right:150px;z-index:10000"
            onclick="javascript:doLOS();">LOS</button>

</body>
</html>
